user  nginx;
worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 10240;
    multi_accept on;
    use epoll;
}

http {
    include       mime.types;
    include       /etc/nginx/conf.d/*.conf;
    include       /etc/nginx/service-url.inc;

    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout 30;
    client_max_body_size 20M;

    log_format json_combined escape=json
    '{ "time_local":"$time_local",'
    '  "remote_addr":"$remote_addr",'
    '  "request_method":"$request_method",'
    '  "request_uri":"$request_uri",'
    '  "status":$status,'
    '  "body_bytes_sent":$body_bytes_sent,'
    '  "request_time":$request_time,'
    '  "upstream_response_time":"$upstream_response_time",'
    '  "http_referrer":"$http_referer",'
    '  "http_user_agent":"$http_user_agent",'
    '  "host":"$host" }';

    access_log /var/log/nginx/access.log json_combined;
    error_log  /var/log/nginx/error.log;

    # ✅ 추가: SSE 연결 수 제한 (DDoS 방지)
    limit_conn_zone $binary_remote_addr zone=sse_limit:10m;
    limit_req_zone $binary_remote_addr zone=sse_req_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name sse.pickeat.io.kr 10.0.2.36;
        charset utf-8;

        location ^~ /.well-known/acme-challenge/ {
            allow all;
            root /var/www/certbot;
            default_type "text/plain";
            try_files $uri =404;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        server_name sse.pickeat.io.kr 10.0.2.36;
        server_tokens off;

        ssl_certificate     /etc/letsencrypt/live/sse.pickeat.io.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/sse.pickeat.io.kr/privkey.pem;

        include     /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        location = /healthz {
            add_header Content-Type text/plain;
            return 200 "ok\n";
        }

        # ✅ SSE 엔드포인트 전용 설정
        location /sse/ {
            # 연결 수 제한
            limit_conn sse_limit 10;        # IP당 최대 10개 SSE 연결
            limit_req zone=sse_req_limit burst=5 nodelay;

            proxy_pass $service_url;

            # HTTP/1.1 keep-alive 필수
            proxy_http_version 1.1;
            proxy_set_header Connection '';

            # 기본 헤더
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;

            # ⭐ SSE 핵심 설정
            proxy_buffering off;              # 버퍼링 완전 비활성화
            proxy_cache off;                  # 캐싱 비활성화
            chunked_transfer_encoding on;     # chunked 인코딩 활성화

            # ⭐ 긴 연결 타임아웃 (1시간)
            proxy_connect_timeout 10s;
            proxy_send_timeout    3600s;      # 1시간
            proxy_read_timeout    3600s;      # 1시간

            # 연결 끊김 시 로깅
            proxy_intercept_errors on;
            error_page 502 503 504 = @sse_error;
        }

        # SSE 에러 핸들링
        location @sse_error {
            add_header Content-Type text/event-stream;
            return 200 "event: error\ndata: {\"message\":\"SSE server unavailable\"}\n\n";
        }

        location /internal/ {
            proxy_pass $service_url;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;

            proxy_connect_timeout 10s;
            proxy_send_timeout    60s;
            proxy_read_timeout    60s;
            proxy_buffering on;
        }

        location /actuator/ {
            proxy_pass $service_url;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;
        }

        location ~ ^/(swagger|redoc|swagger-resources|swagger-ui\.html|webjars|v3|csrf) {
            proxy_pass $service_url;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host  $host;
            proxy_set_header X-Forwarded-Port  $server_port;
        }
    }
}
